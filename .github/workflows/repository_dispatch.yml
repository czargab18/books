name: renderbooks_create_pr
description: Renderiza livros Quarto e cria 'Pull Request' automaticamente para revisão
# modelos de ia: Cloude Sonnet 4 e Gemini Pro

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]

permissions:
  contents: write
  actions: write

env:
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}

jobs:
  repository_dispatch:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT

    steps:
      - name: Configura credenciais do Git para submódulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          fetch-depth: 5 # no mínimo 2 para pegar o commit anterior
        env:
          TOKEN: ${{ env.TOKEN }}

      - name: Verificar arquivos alterados no push
        id: verificar_arquivos_no_push
        run: |
          ARQUIVOS_MODIFICADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          PASTAS_MODIFICADAS=$(echo "$ARQUIVOS_MODIFICADOS" | grep -oE '^build/[A-Z]{3}[0-9]{4}' | sed 's|build/||' | sort | uniq)
          echo "Pastas modificadas: $PASTAS_MODIFICADAS"
          PASTAS_JSON=$(echo "$PASTAS_MODIFICADAS" | awk '{printf \"\"%s\"\",", $0}' | sed 's/,$//')
          echo "PASTAS_JSON=$PASTAS_JSON" >> $GITHUB_OUTPUT

      - name: Dispara 'repository_dispatch' no estatistica
        if: ${{ steps.verificar_arquivos_no_push.outputs.PASTAS_JSON != '' }}
        uses: peter-evans/repository-dispatch@v3
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          event-type: atualizar-books
          client-payload: ${{ steps.verificar_arquivos_no_push.outputs.PASTAS_JSON }}
