name: renderbooks_create_pr
# description: Avisa ao repositÃ³rio estatistica sobre livros atualizados para renderizaÃ§Ã£o
# modelos de ia: Cloude Sonnet 4 e Gemini Pro

on:
  workflow_dispatch:
    inputs:
      livros:
        description: 'Livros para renderizar (ex: "TAS0000","EST0033" ou "all" para todos)'
        required: false
        default: 'all'
        type: string
  push:
    branches: [main]
    paths: ["book/**"]

permissions:
  contents: write
  actions: write

env:
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}

jobs:
  repository_dispatch:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT

    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 5
          token: ${{ env.TOKEN }}

      - name: Detectar livros modificados e gerar payload
        id: gerar_payload
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            INPUT_LIVROS="${{ inputs.livros }}"
            
            if [ "$INPUT_LIVROS" == "all" ]; then
              LIVROS_DETECTADOS=$(find book -maxdepth 1 -type d -name '[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9]' -printf '%f\n' | sort | xargs)
              echo "ðŸ“š Todos os livros: $LIVROS_DETECTADOS"
            else
              LIVROS_DETECTADOS=$(echo "$INPUT_LIVROS" | tr ',' ' ' | xargs)
              echo "ðŸ“š Livros especificados: $LIVROS_DETECTADOS"
            fi
          else
            ARQUIVOS_MODIFICADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            LIVROS_DETECTADOS=$(echo "$ARQUIVOS_MODIFICADOS" | grep -oE '^book/[A-Z]{3}[0-9]{4}' | sed 's|book/||' | sort | uniq | xargs)
            echo "ðŸ“š Livros detectados por push em book/: $LIVROS_DETECTADOS"
          fi
          
          if [ -z "$LIVROS_DETECTADOS" ]; then
            echo "âš ï¸ Nenhum livro detectado"
            echo "payload=" >> $GITHUB_OUTPUT
            echo "tem_livros=false" >> $GITHUB_OUTPUT
          else
            LIVROS_ARRAY=$(echo "$LIVROS_DETECTADOS" | tr ' ' '\n' | awk '{printf "\"%s\",", $0}' | sed 's/,$//')
            PAYLOAD='{"livros": ['$LIVROS_ARRAY']}'
            echo "payload=$PAYLOAD" >> $GITHUB_OUTPUT
            echo "tem_livros=true" >> $GITHUB_OUTPUT
            echo "âœ… Payload gerado: $PAYLOAD"
          fi

      - name: Dispara 'repository_dispatch' no estatistica
        if: steps.gerar_payload.outputs.tem_livros == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          event-type: atualizar-books
          client-payload: ${{ steps.gerar_payload.outputs.payload }}