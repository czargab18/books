name: render-books
description: Renderiza livros Quarto e cria PR para revisÃ£o

on:
  push:
    branches: [main]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}

jobs:
  render:
    runs-on: ubuntu-latest
    outputs:
      pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ env.TOKEN }}
          fetch-depth: 0

      - name: Configura Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Cria diretÃ³rio de renderizaÃ§Ã£o
        run: |
          echo "ğŸ“ Criando diretÃ³rio para livros renderizados..."
          mkdir -p _rendered

      - name: Lista livros vÃ¡lidos
        id: list-books
        run: |
          echo "ğŸ” Buscando livros com padrÃ£o [A-Z]{3}[0-9]{4}..."
          find build -maxdepth 1 -type d -regex '.*/[A-Z]{3}[0-9]{4}' -printf '%f\n' | sort > book_list.txt

      - name: Renderiza livros Quarto
        run: |
          for folder in $(cat book_list.txt); do
            if [ -d "build/$folder" ]; then
              quarto render "build/$folder" --to html --execute --output-dir "_rendered/$folder"
            fi
          done
      
      - name: Sincronizar '_rendered/' e 'book/'
        run: |
          echo "ğŸ”„ Removendo arquivos duplicados de book/..."
          for folder in $(ls _rendered 2>/dev/null); do
            if [ -d "book/$folder" ]; then
              for file in $(find _rendered/$folder -type f); do
                relpath=${file#_rendered/}
                if [ -f "book/$relpath" ]; then
                  rm "book/$relpath"
                  echo "Removido: book/$relpath"
                fi
              done
            fi
          done

      - name: Move livros de '_rendered/' para 'book/'
        run: |
          echo "ğŸšš Movendo livros renderizados para a pasta book/..."
          for folder in $(ls _rendered 2>/dev/null); do
            mkdir -p "book/$folder"
            rsync -a --remove-source-files "_rendered/$folder/" "book/$folder/"
          done

      # - name: Gera Ã­ndice dos livros (JSON)
      #   run: |
      #     echo "ğŸ“‹ Gerando Ã­ndice de livros..."
      #     echo '{ "books": [' > book/books-index.json

      #     first=true
      #     for folder in $(ls book 2>/dev/null | grep -E '^[A-Z]{3}[0-9]{4}'); do
      #       if [ "$first" = true ]; then
      #         first=false
      #       else
      #         echo ',' >> book/books-index.json
      #       fi
      #       echo "  { \"id\": \"$folder\", \"path\": \"book/$folder/index.html\" }" >> book/books-index.json
      #     done

      #     echo ']}' >> book/books-index.json

      # ================================================
      # ================================================
      # Ao usar a aÃ§Ã£o 'peter-evans/create-pull-request' no GitHub Actions,
      # nÃ£o Ã© necessÃ¡rio criar manualmente um commit ou uma branch antes.
      # A prÃ³pria aÃ§Ã£o faz tudo automaticamente:
      # - Cria uma branch nova (ex: books-render-20250927-123456)
      # - Adiciona e commita todas as mudanÃ§as feitas pelo workflow
      # - Cria a Pull Request dessa branch para
      # ================================================
      # ================================================

      - name: Cria Pull Request para branch padrÃ£o
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ env.TOKEN }}
          branch: book-$(date +%Y%m%d-%H%M%S)
          base: main # ou master, dependendo da sua branch padrÃ£o
          title: "books: atualiza books renderizados pelo GitHub Actions"
          labels: |
            books
            quarto
            action
            needs-review
            automated-pr
          assignees: ${{ github.repository_owner }}
          draft: false
          commit-message: |
            books: atualiza livros renderizados

            Livros processados:
            $(ls _rendered 2>/dev/null | sed 's/^/- /' || echo "- Nenhum")

            - RenderizaÃ§Ã£o Quarto â†’ HTML
            - Ãndice JSON gerado automaticamente
            - Estrutura organizada em book/

            Commit fonte: ${{ github.sha }}
            Data: $(date +'%Y-%m-%d %H:%M:%S UTC')
          body: |
            ## ğŸ“– Nova RenderizaÃ§Ã£o dos Livros Quarto

            Esta PR contÃ©m os livros atualizados renderizados a partir das mudanÃ§as aprovadas enviadas para a branch `main`.

            ### ğŸ“‹ Detalhes da RenderizaÃ§Ã£o
            - **Commit fonte**: ${{ github.sha }}
            - **Workflow**: ${{ github.run_id }}
            - **Data**: $(date +'%Y-%m-%d %H:%M:%S UTC')
            - **Triggering commit**: ${{ github.event.head_commit.message }}

            ### ğŸ“š Livros Renderizados
            $(ls _rendered 2>/dev/null | sed 's/^/- ğŸ“– /' || echo "- Nenhum livro renderizado")

            ### ğŸ”„ MudanÃ§as IncluÃ­das
            - âœ… Livros Quarto renderizados para HTML na pasta `book/`
            - âœ… Ãndice de livros atualizado (`book/books-index.json`)
            - âœ… Estrutura de arquivos organizada

            ### ğŸ“ Estrutura Adicionada/Atualizada
            ```
            book/
            â”œâ”€â”€ livro1/
            â”œâ”€â”€ livro2/
            â””â”€â”€ ...
            ```

            ### ğŸ“ Arquivos Principais
            - `book/books-index.json` - Ãndice com metadata dos livros
            - `book/*/index.html` - PÃ¡ginas principais dos livros
            - Assets e recursos complementares

            ---

            ## ğŸ‘€ Review Checklist

            Por favor, verifique:
            - [ ] ğŸ“– Livros foram renderizados corretamente
            - [ ] ğŸ¨ FormataÃ§Ã£o e estilos estÃ£o adequados  
            - [ ] ğŸ”— Links internos funcionam
            - [ ] ğŸ“± Layout Ã© responsivo
            - [ ] ğŸ“‹ Ãndice JSON estÃ¡ correto
            - [ ] ğŸ“ Estrutura de pastas estÃ¡ organizada

            ---
            **âš ï¸ Esta PR requer aprovaÃ§Ã£o manual do proprietÃ¡rio antes do merge.**

      - name: Adiciona comentÃ¡rio com instruÃ§Ãµes
        if: steps.create-pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ env.TOKEN }}
          issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
          body: |
            ## ğŸ¤– InstruÃ§Ãµes AutomÃ¡ticas

            ### ğŸ“‹ Status do Workflow
            âœ… Livros renderizados com sucesso  
            âœ… Pull Request criada  
            â³ **Aguardando sua aprovaÃ§Ã£o**  

            ### ğŸ” Como Revisar

            1. **Verifique os arquivos alterados** na aba "Files changed"
            2. **Teste os livros localmente** se necessÃ¡rio:
               ```bash
               git checkout update-books-$(date +%Y%m%d-%H%M%S)
               # Abra book/*/index.html no navegador
               ```
            3. **Aprove a PR** quando estiver satisfeito

            ### ğŸ“ Arquivos Importantes
            - `books-index.json` - Metadata dos livros
            - Cada pasta de livro contÃ©m o HTML renderizado

            ---
            *Esta PR foi criada automaticamente e **requer sua aprovaÃ§Ã£o** para merge.*

      - name: Limpa arquivos temporÃ¡rios
        run: |
          rm -rf _rendered
          echo "âœ… Arquivos temporÃ¡rios removidos"

  # create-pr: usando artefato
          
  notificar-estatistica:
    needs: [render]
    environment:
      name: ENVIRONMENT
    runs-on: ubuntu-latest
    steps:
      - name: Dispara 'repository_dispatch' no estatistica
        uses: peter-evans/repository-dispatch@v3
        with:
          repository: ${{ env.USERNAME }}/estatistica
          token: ${{ env.TOKEN }}
          event-type: atualizar-books

      # Posteriormente: Talvez seja Ãºtil detectar os livros modificados e enviar como client-payload
      # client-payload: '{"livros": ["livro1", "livro2"]}'
