name: render_create_pr
description: Renderiza livros Quarto e cria 'Pull Request' automaticamente para revisÃ£o
# modelos de ia: Cloude Sonnet 4 e Gemini Pro

on:
  workflow_dispatch:
  push:
    branches: [main, stag, book, dev1]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]

permissions:
  contents: write
  actions: write
  pull-requests: write

env:
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}

jobs:
  renderizar:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT

    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ env.TOKEN }}
          path: books

      - name: Configura Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      # - name: Cria pasta '_rendered'
      #   run: |
      #     echo "Criando diretÃ³rio para os livros renderizados..."
      #     mkdir -p _rendered

      - name: Renderiza livros Quarto
        working-directory: books
        run: |
          for folder in $(ls build); do
            if [ -d "build/$folder" ]; then
              echo "Renderizando livro: $folder"
              quarto render "build/$folder" --to html --execute --output-dir "./../_rendered/$folder"
            fi
          done

      - name: Verificar pasta 'books/book' existe
        working-directory: books
        id: check-book-folder
        run: |
          if [ ! -d "book" ]; then
            echo "A pasta 'book' nÃ£o existe. Criando a pasta..."
            mkdir -p book
          else
            echo "A pasta 'book' jÃ¡ existe."
          fi

      - name: Lista os livros renderizados
        run: |
          echo "Livros renderizados:"
          echo "RENDERED_BOOKS=$(ls build/_rendered | xargs)" >> $GITHUB_ENV

      - name: Remove versÃµes antigas dos livros renderizados
        working-directory: books
        run: |
          for folder in ${{ env.RENDERED_BOOKS }}; do
            rm -rf "book/$folder"
          done

      - name: Move novos livros renderizados para book
        run: |
          for folder in ${{ env.RENDERED_BOOKS }}; do
            mv "build/_rendered/$folder" "book/$folder"
          done

      - name: Commit e criar Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: book
          title: "book: atualiza novos livros Quarto renderizados"
          labels: |
            books
            quarto
            action
            needs-review
            automated-pr
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner  }}
          draft: false
          commit-message: |
            books: atualiza livros renderizados

            Livros processados:
            $(ls book 2>/dev/null | grep -E '^[A-Z]{3}[0-9]{4}' | sed 's/^/- /' || echo "- Nenhum")

            - RenderizaÃ§Ã£o Quarto â†’ HTML
            - Estrutura organizada em book/

            Commit fonte: ${{ github.sha }}
            Data: $(date +'%Y-%m-%d %H:%M:%S UTC')
          body: |
            ## ğŸ“– atualiza books renderizados pelo GitHub Actions

            Esta 'pull_request' contÃ©m a atualizaÃ§Ã£o dos livros renderizados, via GitHub Actions, a partir dos arquivos fonte em Quarto (.qmd) presentes na pasta `build/`.

            ### ğŸ“‹ Detalhes da RenderizaÃ§Ã£o
            - **Commit fonte**: `${{ github.sha }}`
            - **Workflow**: `${{ github.run_id }}`
            - **Data**: $(date +'%Y-%m-%d %H:%M:%S UTC')
            - **Triggering commit**: `${{ github.event.head_commit.message }}`

            ### ğŸ“š Livros Renderizados
            $(ls book 2>/dev/null | grep -E '^[A-Z]{3}[0-9]{4}' | sed 's/^/- ğŸ“– /' || echo "- Nenhum livro renderizado")

            ## ğŸ‘€ Review Checklist
            Por favor, verifique se todos os livros foram renderizados corretamente e estÃ£o prontos para publicaÃ§Ã£o.:
            - [ ] ğŸ“– Livros foram renderizados corretamente
            - [ ] ğŸ¨ FormataÃ§Ã£o e estilos estÃ£o adequados
            - [ ] ğŸ”— Links internos funcionam
            - [ ] ğŸ“± Layout Ã© responsivo
            - [ ] ğŸ“ Estrutura de pastas estÃ¡ organizada

            ---
            **âš ï¸ Esta PR requer aprovaÃ§Ã£o manual do proprietÃ¡rio antes do merge.**

      # # (Opcional) Aprovar PR automaticamente
      # - name: Aprovar PR automaticamente
      #   if: ${{ github.actor == 'github-actions[bot]' }}
      #   uses: hmarr/auto-approve-action@v4
      #   with:
      #     pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}

      # # (Opcional) Merge automÃ¡tico
      # - name: Merge automÃ¡tico
      #   if: ${{ github.actor == 'github-actions[bot]' }}
      #   uses: pascalgn/automerge-action@v0.15.6
      #   with:
      #     pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}
