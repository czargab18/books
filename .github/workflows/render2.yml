#> CÃ³digo gerado/assistido por IA - revisar cuidadosamente antes de usar.
#> Agent AI: github-copilot-chat - vscode

# description: Workflow para renderizar livros em Quarto e criar Pull Requests automaticamente.
# version: 2.0.0
name: render_v2

on:
  push:
    branches: [main]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]
  workflow_dispatch:
    inputs:
      livros:
        description: 'Livros para renderizar (ex: "TAS0000","EST0033" ou "all" para todos)'
        required: false
        default: "all"
        type: string

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  pages: write
  id-token: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  books:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Configura credenciais do Git para submÃ³dulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ env.USERNAME }}/books
          token: ${{ env.TOKEN }}
          ref: "stag"
          fetch-tags: true
          submodules: false

      - name: Detectar evento de gatilho do GitHub
        id: detectar_evento
        run: |
          EVENTO="${{ github.event_name }}"
          echo "Evento detectado: $EVENTO"
          echo "evento=$EVENTO" >> $GITHUB_OUTPUT

      - name: Detectar livros para renderizar de 'workflow_dispatch'
        if: github.event_name == 'workflow_dispatch'
        id: detectar_livros_workflow_dispatch
        run: |
          INPUT_LIVROS="${{ github.event.inputs.livros }}"
          
          if [ "$INPUT_LIVROS" == "all" ]; then
            LISTA=$(find build -maxdepth 1 -type d -name '[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9]' -printf '%f\n' | sort | xargs)
            echo "ğŸ“š Renderizando todos os livros: $LISTA"
          else
            LISTA=$(echo "$INPUT_LIVROS" | tr ',' ' ' | xargs)
            echo "ğŸ“š Renderizando livros especificados: $LISTA"
          fi
          
          echo "lista_livros=$LISTA" >> $GITHUB_OUTPUT
          echo "âœ… Lista salva: $LISTA"

      - name: Detectar livros para renderizar de 'push'
        id: detectar_livros_push
        if: github.event_name == 'push'
        run: |
          ARQUIVOS_MODIFICADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          LISTA=$(echo "$ARQUIVOS_MODIFICADOS" | grep -oE '^build/[A-Z]{3}[0-9]{4}' | sed 's|build/||' | sort | uniq | xargs)
          
          echo "ğŸ“š Livros detectados por push: $LISTA"
          echo "lista_livros=$LISTA" >> $GITHUB_OUTPUT
          echo "âœ… Lista salva: $LISTA"

      - name: Instalar Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "release"
      
      - name: Cria pasta 'book' se nÃ£o existir
        run: |
          mkdir -p book

      - name: Renderizar livros
        id: renderizar_livros
        if: steps.detectar_livros_push.outputs.lista_livros != '' || steps.detectar_livros_workflow_dispatch.outputs.lista_livros != ''
        run: |
          LISTA="${{ steps.detectar_livros_push.outputs.lista_livros || steps.detectar_livros_workflow_dispatch.outputs.lista_livros }}"
          
          if [ -z "$LISTA" ]; then
            echo "âš ï¸ Nenhum livro para renderizar"
            exit 0
          fi
        
          NUM_LIVROS=$(echo "$LISTA" | wc -w)
          echo "ğŸ“š Renderizando $NUM_LIVROS livro(s): $LISTA"
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0

          for livro in $LISTA; do
            if [ -d "build/$livro" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“– Renderizando: $livro"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              if quarto render "build/$livro" --to html --execute --output-dir "./../../book/$livro"; then
                echo "âœ… Sucesso: $livro"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "âŒ Erro ao renderizar: $livro"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            else
              echo "âš ï¸ Livro nÃ£o encontrado: $livro"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Resumo da RenderizaÃ§Ã£o"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Sucesso: $SUCCESS_COUNT"
          echo "âŒ Falhas: $FAIL_COUNT"
          echo "ğŸ“š Total: $NUM_LIVROS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ComparaÃ§Ã£o segura e saÃ­da explÃ­cita
          if [ "${FAIL_COUNT:-0}" -gt 0 ]; then
            echo "âš ï¸ Alguns livros falharam na renderizaÃ§Ã£o"
            exit 1
          else
            echo "âœ¨ RenderizaÃ§Ã£o concluÃ­da com sucesso!"
            exit 0
          fi


      # 4 criar pull_request 'book' para 'stag'
      # 5 auto-merge e auto-approve
      # 6 repository_dispath para estatistica com payload dos livros renderizados
      # 7 criar pull_request 'stag' para 'main'
