# Código gerado/assistido por IA
name: render
# description: Workflow para atualizar arquivos dos submódulos com o repositório Estatística.

on:
  push:
    branches: [main]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]
  workflow_dispatch:
    inputs:
      livros:
        description: 'Livros para renderizar (ex: "TAS0000","EST0033" ou "all" para todos)'
        required: false
        default: "all"
        type: string

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  pages: write
  id-token: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  books:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Configura credenciais do Git para submódulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ env.USERNAME }}/books
          token: ${{ env.TOKEN }}
          ref: "stag"
          fetch-tags: true
          submodules: false

      - name: Detectar e gerar 'payload' com os livros detectados
        id: gerar_payload
        run: |
          # Se foi acionado manualmente com input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.livros }}" ]; then
            INPUT_LIVROS="${{ inputs.livros }}"
            
            # Se for "all", lista todos os livros disponíveis
            if [ "$INPUT_LIVROS" == "all" ]; then
              LIVROS_DETECTADAS=$(find build -maxdepth 1 -type d -name '[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9]' -printf '%f\n' | sort)
              echo "Renderizando todos os livros: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
            else
              # Lista específica de livros separados por vírgula
              LIVROS_DETECTADAS=$(echo "$INPUT_LIVROS" | tr ',' '\n' | sort | uniq)
              echo "Renderizando livros especificados: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
            fi
          else
            # Detecta automaticamente pelos arquivos modificados (push)
            ARQUIVOS_DETECTADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            LIVROS_DETECTADAS=$(echo "$ARQUIVOS_DETECTADOS" | grep -oE '^build/[A-Z]{3}[0-9]{4}' | sed 's|build/||' | sort | uniq)
            echo "Livros detectados por push: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
          fi

          # Remove linhas vazias e espaços extras
          LIVROS_DETECTADAS=$(echo "$LIVROS_DETECTADAS" | grep -v '^$' | xargs)

          if [ -z "$LIVROS_DETECTADAS" ]; then
            echo "Nenhum livro detectado para renderização"
            echo "payload=" >> $GITHUB_OUTPUT
            echo "tem_livros=false" >> $GITHUB_OUTPUT
          else
            # Converte para array JSON
            LIVROS_ARRAY=$(echo "$LIVROS_DETECTADAS" | tr ' ' '\n' | awk '{printf "\"%s\",", $0}' | sed 's/,$//')
            PAYLOAD='{"livros": ['$LIVROS_ARRAY']}'
            echo "payload=$PAYLOAD" >> $GITHUB_OUTPUT
            echo "tem_livros=true" >> $GITHUB_OUTPUT
            echo "Payload gerado: $PAYLOAD"
          fi

