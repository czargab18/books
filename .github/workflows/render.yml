#> C√≥digo gerado/assistido por IA - revisar cuidadosamente antes de usar.
#> Agent AI: github-copilot-chat - vscode

# description: Workflow para renderizar livros em Quarto e criar Pull Requests automaticamente.
# version: 2.0.0
name: render

on:
  push:
    branches: [stag]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]
  workflow_dispatch:
    inputs:
      livros:
        description: 'Livros para renderizar (ex: "TAS0000","EST0033" ou "all" para todos)'
        required: false
        default: "all"
        type: string

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  pages: write
  id-token: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  books:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Configura credenciais do Git para subm√≥dulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ env.USERNAME }}/books
          token: ${{ env.TOKEN }}
          ref: "stag"
          fetch-tags: true
          submodules: false

      - name: Detectar livros para renderizar de 'workflow_dispatch'
        if: github.event_name == 'workflow_dispatch'
        id: detectar_livros_workflow_dispatch
        run: |
          INPUT_LIVROS="${{ github.event.inputs.livros }}"

          if [ "$INPUT_LIVROS" == "all" ]; then
            LISTA=$(find build -maxdepth 1 -type d -name '[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9]' -printf '%f\n' | sort | xargs)
            echo "üìö Renderizando todos os livros: $LISTA"
          else
            LISTA=$(echo "$INPUT_LIVROS" | tr ',' ' ' | xargs)
            echo "üìö Renderizando livros especificados: $LISTA"
          fi

          echo "lista_livros=$LISTA" >> $GITHUB_OUTPUT
          echo "‚úÖ Lista salva: $LISTA"

      - name: Detectar livros para renderizar de 'push'
        id: detectar_livros_push
        if: github.event_name == 'push'
        run: |
          ARQUIVOS_MODIFICADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          LISTA=$(echo "$ARQUIVOS_MODIFICADOS" | grep -oE '^build/[A-Z]{3}[0-9]{4}' | sed 's|build/||' | sort | uniq | xargs)

          echo "üìö Livros detectados por push: $LISTA"
          echo "lista_livros=$LISTA" >> $GITHUB_OUTPUT
          echo "‚úÖ Lista salva: $LISTA"

      - name: Instalar Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "release"

      - name: Cria pasta 'book' se n√£o existir
        run: |
          mkdir -p book

      - name: Renderizar livros
        id: renderizar_livros
        if: steps.detectar_livros_push.outputs.lista_livros != '' || steps.detectar_livros_workflow_dispatch.outputs.lista_livros != ''
        run: |
          LISTA="${{ steps.detectar_livros_push.outputs.lista_livros || steps.detectar_livros_workflow_dispatch.outputs.lista_livros }}"

          if [ -z "$LISTA" ]; then
            echo "‚ö†Ô∏è Nenhum livro para renderizar"
            exit 0
          fi

          NUM_LIVROS=$(echo "$LISTA" | wc -w)
          echo "üìö Renderizando $NUM_LIVROS livro(s): $LISTA"

          SUCCESS_COUNT=0
          FAIL_COUNT=0

          for livro in $LISTA; do
            if [ -d "build/$livro" ]; then
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üìñ Renderizando: $livro"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              
              if quarto render "build/$livro" --to html --execute --output-dir "./../../book/$livro"; then
                echo "‚úÖ Sucesso: $livro"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "‚ùå Erro ao renderizar: $livro"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            else
              echo "‚ö†Ô∏è Livro n√£o encontrado: $livro"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Resumo da Renderiza√ß√£o"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ Sucesso: $SUCCESS_COUNT"
          echo "‚ùå Falhas: $FAIL_COUNT"
          echo "üìö Total: $NUM_LIVROS"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          # Compara√ß√£o segura e sa√≠da expl√≠cita
          if [ "${FAIL_COUNT:-0}" -gt 0 ]; then
            echo "‚ö†Ô∏è Alguns livros falharam na renderiza√ß√£o"
            exit 1
          else
            echo "‚ú® Renderiza√ß√£o conclu√≠da com sucesso!"
            exit 0
          fi

      - name: Remover pastas de bibliotecas geradas pelo Quarto
        working-directory: book
        run: |
          LISTA="site_libs _libs index_files book_libs"
          for pasta in $LISTA; do
            echo "üóëÔ∏è Removendo pastas: $pasta"
            find . -type d -name "$pasta" -exec rm -rf {} + 2>/dev/null || true
          done
          echo "‚úÖ Limpeza conclu√≠da"


      - name: Commit e criar Pull Request de 'book' para 'stag'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.TOKEN }}
          base: stag
          branch: book
          delete-branch: true
          title: "book: atualiza livros Quarto renderizados"
          labels: |
            books
            quarto
            action
            automated-pr
          assignees: ${{ github.repository_owner }}
          draft: false
          commit-message: |
            books: atualiza livros renderizados

            Commit fonte: ${{ github.sha }}
            Data: $(date +'%Y-%m-%d %H:%M:%S UTC')
            Evento: ${{ github.event_name }}
            Livros: ${{ steps.detectar_livros_push.outputs.lista_livros || steps.detectar_livros_workflow_dispatch.outputs.lista_livros }}
          body: |
            ## üìñ Atualiza√ß√£o de Livros Renderizados

            ### üìã Detalhes da Renderiza√ß√£o
            - **Commit fonte**: `${{ github.sha }}`
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Evento**: ${{ github.event_name }}

            ### üìö Livros Renderizados
            ```
            ${{ steps.detectar_livros_push.outputs.lista_livros || steps.detectar_livros_workflow_dispatch.outputs.lista_livros }}
            ```

            ### üîÑ Altera√ß√µes Aplicadas
            - ‚úÖ Renderiza√ß√£o Quarto ‚Üí HTML (sa√≠da em `/book/<livro>`)

            ## üëÄ Review Checklist
            - [ ] üìñ Livros renderizados corretamente
            - [ ] üé® Formata√ß√£o e estilos adequados
            - [ ] üîó Links internos funcionam

            ---
            **‚ö†Ô∏è Esta PR requer aprova√ß√£o manual antes do merge.**

      - name: Auto-approve Pull Request de 'book' para 'stag'
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.create-pr.outputs.pull-request-number }}', 10);
            if (prNumber) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE'
              });
              core.info(`PR #${prNumber} approved`);
            }

      - name: Aguardar processamento da aprova√ß√£o
        if: steps.create-pr.outputs.pull-request-number != ''
        run: sleep 3

      - name: Auto-merge Pull Request de 'book' para 'stag'
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_REPO_SYNC }}
          script: |
            const prNumber = parseInt('${{ steps.create-pr.outputs.pull-request-number }}', 10);
            if (prNumber) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              core.info(`PR #${prNumber} merged`);
            }

  pr-main:
    needs: books
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ENVIRONMENT
    steps:
      - name: Criar Pull Request de 'stag' para 'main'
        env:
          GH_TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
          PR_BODY: |
            ## ÔøΩ Sincroniza√ß√£o stag ‚Üí main
            
            Esta Pull Request sincroniza as altera√ß√µes da branch `stag` (staging) para a branch `main` (produ√ß√£o).
            
            ### üìã Detalhes
            - **Branch origem**: `stag`
            - **Branch destino**: `main`
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ‚úÖ Checklist
            - [ ] Verificar se todos os livros est√£o renderizados corretamente
            - [ ] Confirmar que os testes passaram
            - [ ] Revisar altera√ß√µes cr√≠ticas
            
            **‚ö†Ô∏è Esta PR requer aprova√ß√£o manual antes do merge para produ√ß√£o.**
        run: |
          EXISTING_PR=$(gh pr list --repo ${{ github.repository }} --base main --head stag --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR j√° existe: #$EXISTING_PR"
            echo "üîó https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
          else
            gh pr create \
              --repo ${{ github.repository }} \
              --base main \
              --head stag \
              --title "release: sincroniza stag ‚Üí main" \
              --body "$PR_BODY" \
              --assignee ${{ github.repository_owner }}
            
            echo "‚úÖ PR criada com sucesso!"
            echo "üí° Dica: Crie as labels 'release', 'sync', 'automated-pr' no reposit√≥rio para categoriz√°-la automaticamente"
          fi
