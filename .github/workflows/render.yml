# CÃ³digo gerado/assistido por IA
name: render
# description: Workflow para atualizar arquivos dos submÃ³dulos com o repositÃ³rio EstatÃ­stica.

on:
  push:
    branches: [main]
    paths: ["build/**/*.qmd", "build/**/*.yml", "build/*.bib"]
  workflow_dispatch:
    inputs:
      livros:
        description: 'Livros para renderizar (ex: "TAS0000","EST0033" ou "all" para todos)'
        required: false
        default: "all"
        type: string

env:
  url: ${{ vars.URL }}
  TOKEN: ${{ secrets.TOKEN_REPO_SYNC }}
  USERNAME: ${{ github.repository_owner }}
  USEREMAIL: ${{ secrets.USEREMAIL }}

permissions:
  pages: write
  id-token: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  books:
    runs-on: ubuntu-latest
    environment:
      name: ENVIRONMENT
    steps:
      - name: Configura credenciais do Git para submÃ³dulos privados
        run: |
          git config --global url."https://${{ env.TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ env.USERNAME }}/books
          token: ${{ env.TOKEN }}
          ref: "stag"
          fetch-tags: true
          submodules: false

      - name: Detectar e gerar 'payload' com os livros detectados
        id: gerar_payload
        run: |
          # Se foi acionado manualmente com input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.livros }}" ]; then
            INPUT_LIVROS="${{ inputs.livros }}"
            
            # Se for "all", lista todos os livros disponÃ­veis
            if [ "$INPUT_LIVROS" == "all" ]; then
              LIVROS_DETECTADAS=$(find build -maxdepth 1 -type d -name '[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9]' -printf '%f\n' | sort)
              echo "Renderizando todos os livros: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
            else
              # Lista especÃ­fica de livros separados por vÃ­rgula
              LIVROS_DETECTADAS=$(echo "$INPUT_LIVROS" | tr ',' '\n' | sort | uniq)
              echo "Renderizando livros especificados: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
            fi
          else
            # Detecta automaticamente pelos arquivos modificados (push)
            ARQUIVOS_DETECTADOS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            LIVROS_DETECTADAS=$(echo "$ARQUIVOS_DETECTADOS" | grep -oE '^build/[A-Z]{3}[0-9]{4}' | sed 's|build/||' | sort | uniq)
            echo "Livros detectados por push: $(echo $LIVROS_DETECTADAS | tr '\n' ' ')"
          fi

          # Remove linhas vazias e espaÃ§os extras
          LIVROS_DETECTADAS=$(echo "$LIVROS_DETECTADAS" | grep -v '^$' | xargs)

          if [ -z "$LIVROS_DETECTADAS" ]; then
            echo "Nenhum livro detectado para renderizaÃ§Ã£o"
            # SaÃ­das: payload (JSON objeto), livros (JSON array), livros_list (espaÃ§o-separado), tem_livros
            echo "payload=" >> $GITHUB_OUTPUT
            echo "livros=" >> $GITHUB_OUTPUT
            echo "livros_list=" >> $GITHUB_OUTPUT
            echo "tem_livros=false" >> $GITHUB_OUTPUT
          else
            # Converte para array JSON (ex: ["EST0033","MAT0075"]) e tambÃ©m gera o payload {"livros": [...]} para outros workflows
            LIVROS_ARRAY=$(echo "$LIVROS_DETECTADAS" | tr ' ' '\n' | awk '{printf "\"%s\",", $0}' | sed 's/,$//')
            LIVROS_JSON='['$LIVROS_ARRAY']'
            PAYLOAD='{"livros": ['$LIVROS_ARRAY']}'
            # Emite saÃ­das: payload (objeto JSON), JSON array e string espaÃ§o-separada para compatibilidade
            echo "payload=$PAYLOAD" >> $GITHUB_OUTPUT
            echo "livros=$LIVROS_JSON" >> $GITHUB_OUTPUT
            echo "livros_list=$LIVROS_DETECTADAS" >> $GITHUB_OUTPUT
            echo "tem_livros=true" >> $GITHUB_OUTPUT
            echo "Livros gerados (JSON): $LIVROS_JSON"
          fi

      - name: Instalar Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "release"

      - name: Renderizar livros Quarto
        run: |
          # Aceita dois formatos de saÃ­da do passo anterior:
          # - JSON array em steps.gerar_payload.outputs.livros (ex: ["EST0033","MAT0075"]) 
          # - lista espaÃ§o-separada em steps.gerar_payload.outputs.livros_list
          LIVROS_JSON='${{ steps.gerar_payload.outputs.livros }}'
          LIVROS_LIST_ESC='${{ steps.gerar_payload.outputs.livros_list }}'

          # Converte JSON para lista espaÃ§o-separada sem depender de jq/python
          if [ -n "$LIVROS_JSON" ] && [ "$LIVROS_JSON" != "[]" ]; then
            # remove colchetes e aspas, troca vÃ­rgulas por espaÃ§o
            LIVROS_LIST=$(echo "$LIVROS_JSON" | sed -e 's/\[//g' -e 's/\]//g' -e 's/"//g' -e 's/,/ /g' | xargs)
          else
            LIVROS_LIST=$(echo "$LIVROS_LIST_ESC" | xargs)
          fi

          # Garante que a pasta de saÃ­da exista
          mkdir -p _books

          if [ -z "$LIVROS_LIST" ]; then
            echo "âš ï¸ Nenhum livro para renderizar"
            exit 0
          fi

          # Conta quantos livros
          NUM_LIVROS=$(echo "$LIVROS_LIST" | wc -w)
          echo "ğŸ“š Renderizando $NUM_LIVROS livro(s)..."

          # Contador de sucesso e falha
          SUCCESS_COUNT=0
          FAIL_COUNT=0

          for livro in $LIVROS_LIST; do
            if [ -d "build/$livro" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“– Renderizando: $livro"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              if quarto render "build/$livro" --to html --execute --output-dir "./_books/$livro"; then
                echo "âœ… Sucesso: $livro"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                # SaÃ­da escrita apenas em ./_books/$livro (nÃ£o copiamos para build/)
              else
                echo "âŒ Erro ao renderizar: $livro"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            else
              echo "âš ï¸ Livro nÃ£o encontrado: $livro"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Resumo da RenderizaÃ§Ã£o"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Sucesso: $SUCCESS_COUNT"
          echo "âŒ Falhas: $FAIL_COUNT"
          echo "ğŸ“š Total: $NUM_LIVROS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ComparaÃ§Ã£o segura e saÃ­da explÃ­cita
          if [ "${FAIL_COUNT:-0}" -gt 0 ]; then
            echo "âš ï¸ Alguns livros falharam na renderizaÃ§Ã£o"
            exit 1
          else
            echo "âœ¨ RenderizaÃ§Ã£o concluÃ­da com sucesso!"
            exit 0
          fi



      - name: Commit e criar Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.TOKEN }}
          base: stag
          branch: book
          delete-branch: true
          title: "book: atualiza novos livros Quarto renderizados"
          labels: |
            books
            quarto
            action
            needs-review
            automated-pr
          assignees: ${{ github.repository_owner }}
          # reviewers: ${{ env.USERNAME }}
          draft: false
          commit-message: |
            books: atualiza e padroniza livros renderizados

            Commit fonte: ${{ github.sha }}
            Data: $(date +'%Y-%m-%d %H:%M:%S UTC')
            Livros renderizados: ${{ steps.gerar_payload.outputs.livros }}
            Modo: ${{ steps.gerar_payload.outputs.render_all == 'true' && 'Todos os livros' || 'Livros especÃ­ficos' }}
          body: |
            ## ğŸ“– AtualizaÃ§Ã£o de Livros Renderizados

            Esta Pull Request contÃ©m a atualizaÃ§Ã£o dos livros renderizados via GitHub Actions a partir dos arquivos fonte em Quarto (.qmd) presentes na pasta `build/` e os artefatos foram salvos em `/_books/` na raiz do repositÃ³rio.

            ### ğŸ“‹ Detalhes da RenderizaÃ§Ã£o
            - **Commit fonte**: `${{ github.sha }}`
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Modo**: ${{ steps.gerar_payload.outputs.render_all == 'true' && 'ğŸ”„ Todos os livros' || 'ğŸ¯ Livros especÃ­ficos' }}

            ### ğŸ“š Livros Renderizados
            ```
            ${{ steps.gerar_payload.outputs.livros }}
            ```

            ### ğŸ”„ AlteraÃ§Ãµes Aplicadas
            - âœ… RenderizaÃ§Ã£o Quarto â†’ HTML (saÃ­da em `/_books/<livro>`)
            - âœ… AtualizaÃ§Ã£o do `<head>` dinÃ¢mico
            - âœ… PadronizaÃ§Ã£o do header
            - âœ… PadronizaÃ§Ã£o do footer

            ## ğŸ‘€ Review Checklist
            Por favor, verifique se todos os livros foram renderizados corretamente:
            - [ ] ğŸ“– Livros renderizados corretamente
            - [ ] ğŸ¨ FormataÃ§Ã£o e estilos adequados
            - [ ] ğŸ”— Links internos funcionam
            - [ ] ğŸ“± Layout responsivo
            - [ ] ğŸ“ Estrutura de pastas organizada

            ---
            **âš ï¸ Esta PR requer aprovaÃ§Ã£o manual do proprietÃ¡rio antes do merge.**

      - name: Auto-approve Pull Request
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ env.TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.create-pr.outputs.pull-request-number }}', 10);
            if (prNumber) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE'
              });
              core.info(`PR #${prNumber} approved`);
            }

      - name: Auto-merge Pull Request
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN_REPO_SYNC }}
          script: |
            const prNumber = parseInt('${{ steps.create-pr.outputs.pull-request-number }}', 10)
            if (!prNumber) {
              core.info('PR number not found from create-pull-request outputs; searching for PR...')
              const prs = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', head: `${context.repo.owner}:book` })
              if (prs.data.length > 0) {
                pr = prs.data[0]
                prNumber = pr.number
              }
            }
            if (prNumber) {
              core.info(`Merging PR #${prNumber}`)
              await github.rest.pulls.merge({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, merge_method: 'squash' })
              core.info('PR merged')
            } else {
              core.info('No PR found to merge')
            }



